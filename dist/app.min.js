var animationLoop,blackThreshold,captureCtx,captureImage,drawAscii,errorCallback,errorTxt,height,init,introTxt,mirror,mirrorCtx,mirrorScale,palette,resolution,reversePalette,snapshot,start,startLink,successCallback,videoEl,whiteThreshold,width;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,width=640,height=360,resolution=.0033,blackThreshold=12,whiteThreshold=230,videoEl=document.querySelector("video"),snapshot=document.querySelector(".snapshot"),mirror=document.querySelector(".mirror"),startLink=document.querySelector(".start"),errorTxt=document.querySelector(".error"),introTxt=document.querySelector(".intro"),snapshot.width=videoEl.videoWidth=width,snapshot.height=videoEl.videoHeight=height,captureCtx=snapshot.getContext("2d"),mirrorScale=3,mirror.width=width*mirrorScale,mirror.height=height*mirrorScale,mirrorCtx=mirror.getContext("2d"),mirrorCtx.font="400 12px Andale Mono",mirrorCtx.fillStyle="#000000",palette="@#$%&8BMW*mwqpdbkhaoQ0OZXYUJCLtfjzxnuvcr[]{}1()|/?Il!i><+_~-;,. ",reversePalette=function(){return palette=palette.split("").reverse().join("")},mirror.onclick=function(r){return reversePalette()},captureImage=function(){var r,e;if(window.stream)return captureCtx.drawImage(videoEl,0,0),e=captureCtx.getImageData(0,0,width,height),r=e.data,drawAscii(r)},drawAscii=function(r){var e,t,o,i,a,n,l,h,s,d,c,m,u,w;for(s="",d=width*resolution,n=1.5*d,mirrorCtx.clearRect(0,0,mirror.width,mirror.height),u=0;u<height;){for(c=0;c<width;)u=Math.floor(u),c=Math.floor(c),o=4*(width*u+c),h=r[o],i=r[o+1],e=r[o+2],a=Math.floor(.3*h+.59*i+.11*e),a=a>whiteThreshold?255:a<blackThreshold?0:Math.floor(255*((a-blackThreshold)/(whiteThreshold-blackThreshold))),l=Math.floor(a/4),t=palette.charAt(l),m=960-width*mirrorScale/2,w=540-height*mirrorScale/2,mirrorCtx.fillText(t,(width-c)*mirrorScale+m,u*mirrorScale+w),s+=t,c+=d;s+="\n",u+=n}return s},animationLoop=function(){return console.log("loop"),captureImage(),requestAnimationFrame(animationLoop)},successCallback=function(r){return window.stream=r,videoEl.src=window.URL.createObjectURL(r),videoEl.play(),start()},errorCallback=function(r){return introTxt.addClass("hidden"),errorTxt.innerHTML="Sorry. There was an error trying to reach your camera.<br/>\nYour browser is probably out of date.<br/>\nWhy not try Chrome?<br/><br/>\nIf you are using Chrome and have a camera connected,<br/>\nrefesh the page and try again.",introTxt.className+=" hidden",console.log("navigator.getUserMedia error: ",r)},init=function(){var r;return window.stream&&(videoElement.src=null,window.stream.stop()),r={video:!0},navigator.getUserMedia?navigator.getUserMedia(r,successCallback,errorCallback):errorCallback},start=function(){return animationLoop()},init();